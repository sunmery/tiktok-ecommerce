// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.28.0
// source: query.sql

package models

import (
	"context"

	"github.com/google/uuid"
)

const EmptyCart = `-- name: EmptyCart :one
DELETE FROM carts.cart_items AS ci
WHERE ci.cart_id = 
    (SELECT c.cart_id
     FROM carts.cart AS c
     WHERE c.user_id = $1 AND c.cart_name = $2)  -- 获取用户的购物车ID
RETURNING 1
`

type EmptyCartParams struct {
	UserID   uuid.UUID `json:"userID"`
	CartName string    `json:"cartName"`
}

// EmptyCart
//
//	DELETE FROM carts.cart_items AS ci
//	WHERE ci.cart_id =
//	    (SELECT c.cart_id
//	     FROM carts.cart AS c
//	     WHERE c.user_id = $1 AND c.cart_name = $2)  -- 获取用户的购物车ID
//	RETURNING 1
func (q *Queries) EmptyCart(ctx context.Context, arg EmptyCartParams) (int32, error) {
	row := q.db.QueryRow(ctx, EmptyCart, arg.UserID, arg.CartName)
	var column_1 int32
	err := row.Scan(&column_1)
	return column_1, err
}

const GetCart = `-- name: GetCart :many
SELECT ci.merchant_id, ci.product_id, ci.quantity
FROM carts.cart_items AS ci
WHERE ci.cart_id = 
    (SELECT c.cart_id
     FROM carts.cart AS c
     WHERE c.user_id = $1 AND c.cart_name = $2)
`

type GetCartParams struct {
	UserID   uuid.UUID `json:"userID"`
	CartName string    `json:"cartName"`
}

type GetCartRow struct {
	MerchantID uuid.UUID `json:"merchantID"`
	ProductID  uuid.UUID `json:"productID"`
	Quantity   int32     `json:"quantity"`
}

// GetCart
//
//	SELECT ci.merchant_id, ci.product_id, ci.quantity
//	FROM carts.cart_items AS ci
//	WHERE ci.cart_id =
//	    (SELECT c.cart_id
//	     FROM carts.cart AS c
//	     WHERE c.user_id = $1 AND c.cart_name = $2)
func (q *Queries) GetCart(ctx context.Context, arg GetCartParams) ([]GetCartRow, error) {
	rows, err := q.db.Query(ctx, GetCart, arg.UserID, arg.CartName)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetCartRow
	for rows.Next() {
		var i GetCartRow
		if err := rows.Scan(&i.MerchantID, &i.ProductID, &i.Quantity); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const RemoveCartItem = `-- name: RemoveCartItem :one

DELETE FROM carts.cart_items AS ci
WHERE ci.cart_id = 
    (SELECT c.cart_id
     FROM carts.cart AS c
     WHERE c.user_id = $1 AND c.cart_name = $2)  -- 获取用户的购物车ID
    AND ci.merchant_id = $3  -- 商家ID
    AND ci.product_id = $4  -- 删除指定商品ID
RETURNING cart_item_id, cart_id, merchant_id, product_id, quantity, created_at, updated_at
`

type RemoveCartItemParams struct {
	UserID     uuid.UUID `json:"userID"`
	CartName   string    `json:"cartName"`
	MerchantID uuid.UUID `json:"merchantID"`
	ProductID  uuid.UUID `json:"productID"`
}

// 获取用户的购物车ID
//
//	DELETE FROM carts.cart_items AS ci
//	WHERE ci.cart_id =
//	    (SELECT c.cart_id
//	     FROM carts.cart AS c
//	     WHERE c.user_id = $1 AND c.cart_name = $2)  -- 获取用户的购物车ID
//	    AND ci.merchant_id = $3  -- 商家ID
//	    AND ci.product_id = $4  -- 删除指定商品ID
//	RETURNING cart_item_id, cart_id, merchant_id, product_id, quantity, created_at, updated_at
func (q *Queries) RemoveCartItem(ctx context.Context, arg RemoveCartItemParams) (CartsCartItems, error) {
	row := q.db.QueryRow(ctx, RemoveCartItem,
		arg.UserID,
		arg.CartName,
		arg.MerchantID,
		arg.ProductID,
	)
	var i CartsCartItems
	err := row.Scan(
		&i.CartItemID,
		&i.CartID,
		&i.MerchantID,
		&i.ProductID,
		&i.Quantity,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const UpsertItem = `-- name: UpsertItem :one
WITH cart_id_cte AS (
    SELECT c.cart_id
    FROM carts.cart AS c
    WHERE c.user_id = $1 AND c.cart_name = $2
    LIMIT 1
),
insert_cart AS (
    INSERT INTO carts.cart (user_id, cart_name)
    SELECT $1, $2
    WHERE NOT EXISTS (SELECT 1 FROM cart_id_cte)
    RETURNING cart_id
)
INSERT INTO carts.cart_items (cart_id, merchant_id, product_id, quantity)
VALUES (
    COALESCE((SELECT cart_id FROM cart_id_cte), (SELECT cart_id FROM insert_cart)),  -- 获取或创建购物车ID
    $3,   -- 商家ID
    $4,   -- 商品ID
    $5   -- 商品数量
)
ON CONFLICT (cart_id, merchant_id, product_id)  -- 如果购物车ID、商家ID和商品ID组合重复
DO UPDATE SET 
    quantity = cart_items.quantity + EXCLUDED.quantity,  -- 更新商品数量
    updated_at = CURRENT_TIMESTAMP  -- 更新时间
RETURNING cart_item_id, cart_id, merchant_id, product_id, quantity, created_at, updated_at
`

type UpsertItemParams struct {
	UserID     uuid.UUID `json:"userID"`
	CartName   string    `json:"cartName"`
	MerchantID uuid.UUID `json:"merchantID"`
	ProductID  uuid.UUID `json:"productID"`
	Quantity   int32     `json:"quantity"`
}

// UpsertItem
//
//	WITH cart_id_cte AS (
//	    SELECT c.cart_id
//	    FROM carts.cart AS c
//	    WHERE c.user_id = $1 AND c.cart_name = $2
//	    LIMIT 1
//	),
//	insert_cart AS (
//	    INSERT INTO carts.cart (user_id, cart_name)
//	    SELECT $1, $2
//	    WHERE NOT EXISTS (SELECT 1 FROM cart_id_cte)
//	    RETURNING cart_id
//	)
//	INSERT INTO carts.cart_items (cart_id, merchant_id, product_id, quantity)
//	VALUES (
//	    COALESCE((SELECT cart_id FROM cart_id_cte), (SELECT cart_id FROM insert_cart)),  -- 获取或创建购物车ID
//	    $3,   -- 商家ID
//	    $4,   -- 商品ID
//	    $5   -- 商品数量
//	)
//	ON CONFLICT (cart_id, merchant_id, product_id)  -- 如果购物车ID、商家ID和商品ID组合重复
//	DO UPDATE SET
//	    quantity = cart_items.quantity + EXCLUDED.quantity,  -- 更新商品数量
//	    updated_at = CURRENT_TIMESTAMP  -- 更新时间
//	RETURNING cart_item_id, cart_id, merchant_id, product_id, quantity, created_at, updated_at
func (q *Queries) UpsertItem(ctx context.Context, arg UpsertItemParams) (CartsCartItems, error) {
	row := q.db.QueryRow(ctx, UpsertItem,
		arg.UserID,
		arg.CartName,
		arg.MerchantID,
		arg.ProductID,
		arg.Quantity,
	)
	var i CartsCartItems
	err := row.Scan(
		&i.CartItemID,
		&i.CartID,
		&i.MerchantID,
		&i.ProductID,
		&i.Quantity,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}
